---
phase: 7
plan: 1
wave: 1
---

# Plan 7.1: Data Logging Infrastructure

## Objective
Establish the backend mechanism to log predictions from Streamlit apps to the SQLite database and ensure the user's email is passed down to those apps.

## Context
- .gsd/SPEC.md
- backend/database.py
- backend/utils.py
- frontend/js/global.js

## Tasks

<task type="auto">
  <name>Add log_prediction function to database.py</name>
  <files>
    - backend/database.py
  </files>
  <action>
    Implement a `log_prediction(email, prediction_type, inputs, outcome)` function that:
    1. Connects to the database.
    2. Resolves the `user_id` from the provided `email`.
    3. Inserts a new record into the `predictions` table with `user_id`, `type`, `inputs` (as JSON string), and `outcome`.
    4. Commits and closes the connection.
  </action>
  <verify>
    Check for syntax errors and correct table/column names from the `init_db` function.
  </verify>
  <done>
    `log_prediction` successfully inserts data into the `predictions` table.
  </done>
</task>

<task type="auto">
  <name>Expose email context in Streamlit and global JS</name>
  <files>
    - backend/utils.py
    - frontend/js/global.js
  </files>
  <action>
    1. In `frontend/js/global.js`: Update the code that appends `lang` to Streamlit URLs (in `updateLanguage` function) to also append the user's `email` from `localStorage` if they are logged in.
    2. In `backend/utils.py`: Add a `get_email()` helper function that extracts the 'email' parameter from `st.query_params`.
  </action>
  <verify>
    Verify `global.js` correctly handles cases where a user is not logged in.
  </verify>
  <done>
    User email is passed via URL and retrievable in Streamlit.
  </done>
</task>

## Success Criteria
- [ ] Backend is capable of receiving and logging prediction data.
- [ ] Frontend correctly propagates user identity to the side-apps.
