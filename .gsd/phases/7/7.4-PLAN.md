# Plan 7.4: Fix Identity Tracking in Dashboard

## Objective
Ensure that registered users are correctly identified in the admin dashboard by their full names instead of "Guest User". This involves making identity propagation more robust and fixing case-sensitivity or parameter reading issues.

## Context
- `backend/utils.py`: Reading email from Streamlit params.
- `backend/database.py`: Looking up user IDs by email.
- `backend/main.py`: Admin statistics query.
- `frontend/js/global.js`: Appending identity to links.

## Tasks

<task type="auto">
  <name>Robust Identity Propagation & Lookup</name>
  <files>
    - backend/utils.py
    - backend/database.py
    - backend/main.py
  </files>
  <action>
    - Update `utils.py` to use a more robust way to read the email parameter from Streamlit `query_params`.
    - Update `database.py` to handle email lookups case-insensitively using `LOWER(email)`.
    - Ensure `main.py` normalizes emails on login/register just in case.
  </action>
  <verify>Check that lookups in database.py use LOWER().</verify>
  <done>Backend correctly resolves user IDs from query params regardless of casing.</done>
</task>

<task type="auto">
  <name>Implement Logging for Medical Bot</name>
  <files>
    - backend/routes/bot.py
  </files>
  <action>
    - Integrate `log_prediction` into the Medical ChatBot to track user queries as part of their activity.
  </action>
  <verify>Check for log_prediction call in bot.py.</verify>
  <done>Bot interactions appear in the admin dashboard activity log.</done>
</task>

## Success Criteria
- [ ] Registered user names appear in "Recent Activity" table.
- [ ] Medical Bot queries are tracked in the dashboard.
- [ ] Identity propagation works consistently across all side-apps.
